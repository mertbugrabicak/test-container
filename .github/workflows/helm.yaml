name: Publish Helm Chart to Quay

on:
  push:
    branches: [ main ]
    # Only run if files in the helm directory change
    paths:
      - 'helm/**'

jobs:
  publish-chart:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Package Helm Chart with Auto-Version
        run: |          
          helm package helm/test-chart \
            --destination . \
            --version "0.1.${{ github.run_number }}" \
            --app-version "${{ github.sha }}"

      - name: Login to Quay.io
        run: |
          echo "${{ secrets.QUAY_PASSWORD }}" | helm registry login quay.io --username "${{ secrets.QUAY_USER }}" --password-stdin

      - name: Push Chart to Quay.io
        run: |
          # The name of the quay repo is the name of the chart
          helm push *.tgz oci://quay.io/${{ secrets.QUAY_USER }}