name: Publish Helm Chart to Quay

on:
  push:
    branches: [ main ]
    # Only run if files in the helm directory change
    paths:
      - 'helm/**'

jobs:
  publish-chart:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Get short SHA
        id: sha
        run: echo "sha=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT

      - name: Package Helm Chart
        run: |
          # --version: Sets the CHART version (e.g., 0.1.55) using the GitHub run number
          # --app-version: Sets the APP version (e.g., a1b2c3d) using the Short SHA
          # Because values.yaml has 'tag: ""', the deployment will default to this AppVersion
          
          helm package helm/test-chart \
            --destination . \
            --version "0.1.${{ github.run_number }}" \
            --app-version "${{ steps.sha.outputs.sha }}"

      - name: Login to Quay.io
        run: |
          echo "${{ secrets.QUAY_PASSWORD }}" | helm registry login quay.io --username "${{ secrets.QUAY_USER }}" --password-stdin

      - name: Push Chart to Quay.io
        run: |
          # This pushes to quay.io/mbicak/test-chart (derived from Chart.yaml name)
          helm push *.tgz oci://quay.io/mbicak